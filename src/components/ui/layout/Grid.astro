---
import type { HTMLTag } from "astro/types";

interface Props {
  columns?: 2 | 3 | 4;
  minWidth?: string;
  gap?: "2xs" | "xs" | "sm" | "md" | "lg" | "xl" | "2xl" | "3xl";
  as?: "div" | "ul" | "ol";
  class?: string;
}

const {
  columns,
  minWidth,
  gap = "lg",
  as = "div",
  class: className,
  ...rest
}: Props = Astro.props;
const Tag = as as HTMLTag;

if (columns && minWidth) {
  throw new Error("Grid: cannot use both 'columns' and 'minWidth'.");
}

if (!columns && !minWidth) {
  throw new Error("Grid: provide either 'columns' or 'minWidth'.");
}

const defaultMinWidths: Record<number, string> = {
  2: "25rem",
  3: "18rem",
  4: "14rem",
};

const gridGap = `var(--space-${gap})`;
const gridMinWidth = columns ? defaultMinWidths[columns] : minWidth;
---

<Tag
  class:list={["grid", className]}
  data-capped={columns ? true : undefined}
  style={`--grid-min-width: ${gridMinWidth}; --grid-gap: ${gridGap};${columns ? ` --grid-col-count: ${columns};` : ""}`}
  {...rest}
>
  <slot />
</Tag>

<style>
  .grid {
    display: grid;
    gap: var(--grid-gap);
    grid-template-columns: repeat(
      auto-fit,
      minmax(min(var(--grid-min-width), 100%), 1fr)
    );

    &:is(ul, ol) {
      list-style: none;
      margin: 0;
      padding: 0;
    }

    &[data-capped] {
      --gap-count: calc(var(--grid-col-count) - 1);
      --total-gap-width: calc(var(--gap-count) * var(--grid-gap));
      --grid-max-width: calc(
        (100% - var(--total-gap-width)) / var(--grid-col-count)
      );

      grid-template-columns: repeat(
        auto-fit,
        minmax(
          min(100%, max(var(--grid-min-width), var(--grid-max-width))),
          1fr
        )
      );
    }
  }
</style>
