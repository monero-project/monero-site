---
import externalLinkIcon from "@/assets/icons/mask/external-link.avif";
import torIcon from "@/assets/icons/mask/tor.avif";
import { getPublicImageDimensions } from "@/utils/image";
import type { HTMLAttributes } from "astro/types";
import { Image } from "astro:assets";
import MaskIcon from "./MaskIcon.astro";

export interface Props extends HTMLAttributes<"div"> {
  href: string;
  title: string;
  subtitle: string;
  logo?: string;
  rtl?: boolean;
  onionHref?: string;
  variant?: "default" | "mini";
}

const {
  href,
  title,
  subtitle,
  logo,
  rtl,
  onionHref,
  variant = "default",
  ...rest
} = Astro.props;
const logoDimensions = logo ? await getPublicImageDimensions(logo) : null;
---

<div
  class={`external-resource-button ${onionHref ? "has-onion" : ""} ${logo ? "has-logo" : ""} ${variant}`}
  {...rest}
>
  <div class="surface">
    <a
      href={href}
      target="_blank"
      rel="noopener noreferrer external"
      class="primary-link"
    >
      {
        logo && logoDimensions && (
          <div class="image">
            <Image
              src={logo}
              alt={`${title} Logo`}
              width={logoDimensions.width}
              height={logoDimensions.height}
              format="avif"
              priority
            />
          </div>
        )
      }

      <div class="text">
        <span class="title">{title}</span>
        <span class="subtitle">{subtitle}</span>
      </div>
    </a>

    <div class={`actions ${onionHref ? "has-onion" : ""}`} aria-label="Links">
      {
        onionHref && (
          <a
            href={onionHref}
            target="_blank"
            rel="noopener noreferrer external"
            class="icon-button onion-link"
            title="Onion service"
            aria-label="Open onion service"
          >
            <MaskIcon src={torIcon} size="1.5em" color="#7D4698" />
          </a>
        )
      }

      <a
        href={href}
        target="_blank"
        rel="noopener noreferrer external"
        class="icon-button external-link"
        title="Open website"
        aria-label="Open website"
      >
        <MaskIcon
          src={externalLinkIcon}
          size="1em"
          color="var(--monero-orange)"
          rtl={rtl}
        />
      </a>
    </div>
  </div>
</div>

<style>
  .external-resource-button {
    display: flex;
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-bold);

    border-radius: 0.5rem;
    padding: 1px;
    background: var(--border-color);

    overflow: visible;
    position: relative;
  }

  .external-resource-button.mini {
    font-size: 1rem;
    font-weight: var(--font-weight-normal);
  }

  .external-resource-button.mini .image {
    height: 2rem;
    width: 2rem;
  }

  .external-resource-button.mini .primary-link {
    padding: 0.75em;
  }

  .external-resource-button.mini .text .subtitle {
    font-size: var(--font-size-sm);
  }

  /* inner surface: clips hover backgrounds to rounded corners */
  .surface {
    display: flex;
    flex: 1;
    border-radius: inherit;
    background: var(--card-color);
    overflow: clip;
  }

  .text {
    flex: 1;
    margin-inline-start: 1rem;
  }

  .external-resource-button:not(.has-logo) .text {
    margin-inline-start: 0;
  }
  .text .title {
    display: block;
    margin: 0;
    font-size: inherit;
    font-weight: inherit;
    color: var(--heading-color);
  }
  .text .subtitle {
    display: block;
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    font-weight: var(--font-weight-normal);
  }

  .image {
    height: 3rem;
    width: 3rem;
    border-radius: 0.5rem;
    overflow: hidden;
  }

  .image img {
    height: 100%;
    object-fit: contain;
  }

  .surface a {
    outline-offset: -3px;
  }
  .surface a::after {
    display: none;
  }

  .primary-link {
    background: transparent;
    border: 0;
    padding: 1em;
    display: flex;
    align-items: center;
    text-decoration: none;
    box-sizing: border-box;
    flex: 1;
  }

  .actions {
    display: flex;
    align-items: stretch;
    justify-content: flex-end;
  }

  /* Only add the actions icon divider when there's an onion link */
  .external-resource-button.has-onion .actions {
    border-inline-start: 1px solid var(--border-color);
  }

  .icon-button {
    width: 3rem;
    display: flex;
    align-items: center;
    justify-content: center;
    box-sizing: border-box;
  }

  .primary-link:hover,
  .icon-button:hover {
    background: var(--card-hover-color);
  }

  /* Only show the inner divider when onion exists */
  .actions.has-onion .external-link {
    border-inline-start: 1px solid var(--border-color);
  }

  .external-resource-button:not(.has-onion):hover .primary-link,
  .external-resource-button:not(.has-onion):hover .icon-button {
    background: var(--card-hover-color);
  }

  @media screen and (max-width: 600px) {
    .actions {
      flex-direction: column;
      justify-content: space-around;
    }
    .actions a {
      flex: 1;
    }
    .actions.has-onion .external-link {
      border-inline-start: unset;
      border-block-start: 1px solid var(--border-color);
    }
  }
</style>
