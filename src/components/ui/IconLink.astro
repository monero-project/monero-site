---
import type { HTMLTag } from "astro/types";
import type { ImageMetadata } from "astro";
import MaskIcon from "./MaskIcon.astro";

import arrowRight from "@/assets/icons/mask/arrow-right.avif";
import externalLink from "@/assets/icons/mask/external-link.avif";

type Size = "sm" | "base" | "lg";
type Weight = "normal" | "medium" | "semibold" | "bold";
type Color = "orange" | "heading" | "inherit";

interface Props {
  href?: string;
  icon?: ImageMetadata | null;
  iconPosition?: "start" | "end";
  iconSize?: string;
  size?: Size;
  weight?: Weight;
  color?: Color;
  underline?: boolean;
  external?: boolean;
  as?: HTMLTag;
  class?: string;
  [key: string]: unknown;
}

const {
  href,
  icon,
  iconPosition = "end",
  iconSize = "1em",
  size = "base",
  weight = "semibold",
  color = "orange",
  underline = false,
  external,
  as,
  class: className,
  ...rest
}: Props = Astro.props;

const { dir } = Astro.locals;
const rtl = dir === "rtl";

const isExternal =
  external ?? (href?.startsWith("http") || href?.startsWith("//"));
const resolvedIcon =
  icon !== undefined ? icon : isExternal ? externalLink : arrowRight;
const Tag = (as ?? (href ? "a" : "span")) as HTMLTag;

const sizeValue = `var(--font-size-${size})`;
const weightValue = `var(--font-weight-${weight})`;
const colorMap = {
  orange: "var(--monero-orange)",
  heading: "var(--heading-color)",
  inherit: "inherit",
};
const colorValue = colorMap[color];
---

<Tag
  href={href}
  class:list={["link", className]}
  data-underline={underline || undefined}
  data-icon-position={iconPosition !== "end" ? iconPosition : undefined}
  target={isExternal ? "_blank" : undefined}
  rel={isExternal ? "noopener noreferrer" : undefined}
  {...rest}
>
  {
    iconPosition === "start" && resolvedIcon && (
      <MaskIcon src={resolvedIcon} size={iconSize} rtl={rtl} />
    )
  }
  <slot />
  {
    iconPosition === "end" && resolvedIcon && (
      <MaskIcon src={resolvedIcon} size={iconSize} rtl={rtl} />
    )
  }
</Tag>

<style define:vars={{ size: sizeValue, weight: weightValue, color: colorValue }}
>
  .link {
    display: inline-flex;
    align-items: center;
    gap: 0.35em;
    text-decoration: none;
    font-size: var(--size);
    font-weight: var(--weight);
    color: var(--color);
  }
  .link::after {
    display: none;
  }
  .link:hover,
  .link:focus-visible {
    opacity: 0.8;
  }
  .link[data-underline]:hover,
  .link[data-underline]:focus-visible {
    opacity: 1;
    text-decoration: underline;
  }
</style>
