---
import { Image } from "astro:assets";
import type { Exchange } from "@/data/get-started/exchanges";

export interface Props {
  exchanges: Exchange[];
  hasKyc: boolean;
}

const { exchanges, hasKyc } = Astro.props as Props;
const { t } = Astro.locals;

if (!exchanges) {
  throw new Error("ExchangeTable component requires 'exchanges' prop.");
}
---

<div class="table-wrap">
  <table class="exchange-table">
    <colgroup>
      <col class="col-name" />
      {hasKyc && <col class="col-kyc" />}
      <col class="col-flag" />
      <col class="col-flag" />
      <col class="col-visit" />
    </colgroup>

    <thead class="exchange-thead">
      <tr>
        <th scope="col">{t("exchanges:table.name")}</th>
        {hasKyc && <th scope="col">{t("exchanges:table.kyc")}</th>}
        <th scope="col">{t("exchanges:table.fiat")}</th>
        <th scope="col">{t("exchanges:table.crypto")}</th>
        <th scope="col" class="th-visit">
          <span class="sr-only">{t("exchanges:table.visit")}</span>
        </th>
      </tr>
    </thead>

    <tbody>
      {
        exchanges.map((ex) => {
          const highlightTags =
            [
              ex.fiat && "fiat",
              ex.crypto && "crypto",
              ex.type === "decentralized" && "privacy",
              ex.type === "aggregator" && "user-friendly",
              ex.userFriendly && "user-friendly",
            ]
              .filter(Boolean)
              .join(" ") || undefined;

          const kycClass = ex.kycClass ?? "";
          const kycText = ex.kycReq ? t(`exchanges:kyc.${ex.kycReq}`) : "";

          return (
            <tr class="exchange-row" data-highlight={highlightTags}>
              <td class="with-icon" data-label={t("exchanges:table.name")}>
                <Image
                  src={ex.img}
                  alt={ex.alt}
                  class="exchange-icon"
                  format="avif"
                  priority
                />
                <span class="exchange-name">{ex.name}</span>
                <span class="exchange-description">
                  {t(`exchanges:descriptions.${ex.id}`)}
                </span>
              </td>

              {hasKyc && (
                <td
                  class:list={["pill", kycClass]}
                  data-label={t("exchanges:table.kyc")}
                >
                  {kycText}
                </td>
              )}

              <td
                class:list={["pill", { checkmark: ex.fiat, cross: !ex.fiat }]}
                data-label={t("exchanges:table.fiat")}
              >
                <span aria-hidden="true">{ex.fiat ? "✓" : "✗"}</span>
              </td>

              <td
                class:list={[
                  "pill",
                  { checkmark: ex.crypto, cross: !ex.crypto },
                ]}
                data-label={t("exchanges:table.crypto")}
              >
                <span aria-hidden="true">{ex.crypto ? "✓" : "✗"}</span>
              </td>

              <td class="visit-cell" data-label={t("exchanges:table.visit")}>
                <a
                  href={ex.url}
                  target="_blank"
                  rel="noopener noreferrer external"
                >
                  {t("exchanges:table.visit")}
                </a>
              </td>
            </tr>
          );
        })
      }
    </tbody>
  </table>
</div>

<style>
  .table-wrap {
    background: var(--card-color);
    border-radius: var(--radius-md);
    overflow: hidden;
  }

  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  td {
    color: var(--text-primary);
  }

  .exchange-row {
    transition: background 0.15s ease;

    &:hover {
      background: var(--card-hover-color);
    }
  }

  .with-icon {
    display: grid;
    grid-template-columns: auto 1fr;
    grid-template-areas:
      "icon name"
      "icon desc";
    column-gap: var(--space-xs);
    align-items: flex-start;
  }

  .exchange-icon {
    grid-area: icon;
    width: 3em;
    border-radius: var(--radius-md);
    vertical-align: middle;
    flex-shrink: 0;
  }

  .exchange-name {
    grid-area: name;
    font-weight: var(--font-weight-semibold);
    color: var(--heading-color);
  }

  .exchange-description {
    grid-area: desc;
    color: var(--paragraph-subtitle);
    font-size: var(--font-size-sm);
    line-height: var(--line-height-caption);
    margin-top: 0.25rem;
  }

  .kyc-required {
    color: #f44336;
  }

  .kyc-optional {
    color: #ff9800;
  }

  .kyc-none,
  .checkmark {
    color: #4caf50;
  }

  .cross {
    color: var(--text-secondary);
  }

  .visit-cell {
    a {
      font-weight: var(--font-weight-medium);
    }
  }

  .th-visit {
    text-align: end;
  }

  @media (width >= 901px) {
    .col-flag {
      width: 1%;
    }

    .col-visit {
      width: 1%;
    }

    .exchange-table :is(th, td):not(:first-child) {
      white-space: nowrap;
      text-align: center;
      padding-inline: var(--space-xl);
    }

    .visit-cell {
      text-align: end;
    }
  }

  /* mobile cards */
  @media (width <= 900px) {
    .table-wrap {
      background: transparent;
      border-radius: 0;
      overflow: visible;
    }

    .exchange-table {
      background: transparent;
    }

    /* hide header visually but keep it accessible */
    .exchange-thead {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .exchange-table tbody {
      display: block;
    }

    .exchange-description {
      margin-top: var(--space-xs);
    }

    /* row separators are handled by cards now */
    .exchange-table tbody tr {
      box-shadow: none;
    }

    .exchange-row {
      display: flex;
      flex-wrap: wrap;
      padding: 0.75rem 0.9rem;
      margin-bottom: var(--space-sm);
      border-radius: var(--radius-lg);
      background: var(--card-color);
      box-shadow: var(--shadow-xs);

      &:last-child {
        margin-bottom: 0;
      }

      & td:not(.pill) {
        padding: 0;
      }

      .with-icon {
        order: 0;
        flex: 1 1 100%;
        grid-template-areas:
          "icon name"
          "desc desc";
        margin-bottom: var(--space-xs);
        column-gap: var(--space-sm);
        align-items: center;
      }

      .exchange-icon {
        width: 2.5rem;
      }
    }

    .pill {
      order: 1;
      flex: 0 0 auto;
      display: inline-flex;
      align-items: center;
      padding: 0.25rem var(--space-xs);
      margin: 0 0.4rem 0.4rem 0;
      border-radius: var(--radius-full);
      font-size: var(--font-size-sm);
      background: var(--card-hover-color);
      line-height: 1;
      white-space: nowrap;
      gap: var(--space-2xs);

      &::before {
        content: attr(data-label);
        text-transform: uppercase;
        letter-spacing: 0.06em;
        font-weight: var(--font-weight-medium);
        font-size: var(--font-size-xs);
        color: var(--paragraph-subtitle);
      }
    }

    .visit-cell {
      order: 2;
      flex: 1 1 100%;
      margin-top: 0.25rem;

      &::before {
        content: "";
        display: block;
        margin-bottom: var(--space-md);
      }

      & a {
        display: inline-flex;
        align-items: center;
        font-size: var(--font-size-sm);
      }
    }
  }
</style>
