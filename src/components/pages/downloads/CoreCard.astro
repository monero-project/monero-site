---
import { createSafeMarkdown } from "@/utils/safeMarkdown.ts";
import type { ImageMetadata } from "astro";
import { Image } from "astro:assets";
import type { TFunction } from "i18next";

import Button from "@/components/ui/Button.astro";
import ColorIcon from "@/components/ui/ColorIcon.astro";
import Dropdown from "@/components/ui/dropdown/Dropdown.astro";
import DropdownItem from "@/components/ui/dropdown/DropdownItem.astro";
import DropdownSeparator from "@/components/ui/dropdown/DropdownSeparator.astro";
import MaskIcon from "@/components/ui/MaskIcon.astro";

import magnetIconDark from "@/assets/icons/color/dark/magnet.avif";
import magnetIcon from "@/assets/icons/color/light/magnet.avif";
import androidIcon from "@/assets/icons/mask/brand/android.avif";
import appleIcon from "@/assets/icons/mask/brand/apple.avif";
import freebsdIcon from "@/assets/icons/mask/brand/freebsd.avif";
import linuxIcon from "@/assets/icons/mask/brand/linux.avif";
import windowsIcon from "@/assets/icons/mask/brand/windows.avif";

export interface DownloadLink {
  href: string;
  platform: "windows" | "macos" | "linux" | "android" | "freebsd";
  format: string;
  size?: string;
  target?: string;
}

interface Props {
  id?: string;
  image: ImageMetadata;
  title: string;
  subtitle: string;
  features: string[];
  downloads: (DownloadLink | "separator")[];
  sourceCodeUrl?: string;
  version?: string;
  versionName?: string;
  releaseNotesUrl?: string;
  torrentUrl?: string;
  magnetUrl?: string;
  verifyLink?: string;
  t: TFunction;
}

const {
  id,
  image,
  title,
  subtitle,
  features,
  downloads,
  sourceCodeUrl,
  version,
  versionName,
  releaseNotesUrl,
  torrentUrl,
  magnetUrl,
  t,
  ...rest
} = Astro.props;

const PLATFORM_ICONS: Record<string, ImageMetadata> = {
  windows: windowsIcon,
  macos: appleIcon,
  linux: linuxIcon,
  android: androidIcon,
  freebsd: freebsdIcon,
};

const safeMarkdown = createSafeMarkdown();
---

<div class="download-card" id={id} {...rest}>
  <div class="card-image">
    <Image src={image} alt="" format="avif" />
  </div>
  <div class="card-content">
    <h2 class="card-title">{title}</h2>
    <p class="card-subtitle">
      {subtitle}
    </p>
    <ul class="card-features">
      {
        features.map((feature) => (
          <li set:html={safeMarkdown.parseInline(feature ?? "")} />
        ))
      }
    </ul>
    <div class="download-actions">
      <Dropdown label={t("downloads.core.downloadButton")}>
        {
          downloads.map((item) =>
            item === "separator" ? (
              <DropdownSeparator />
            ) : (
              <DropdownItem href={item.href} target={item.target}>
                <span class="dropdown-label">
                  {item.platform && (
                    <span class="platform-icon">
                      <MaskIcon
                        src={PLATFORM_ICONS[item.platform]}
                        size="1em"
                      />
                    </span>
                  )}
                  <span>
                    {`${t(`downloads.platforms.${item.platform}`)} (${t(`downloads.core.formats.${item.format}`)})`}
                  </span>
                </span>
                {item.size && <span slot="meta">{item.size}</span>}
              </DropdownItem>
            ),
          )
        }
      </Dropdown>
      {
        torrentUrl && magnetUrl && (
          <div class="torrent-split-button">
            <Button
              variant="secondary"
              href={torrentUrl}
              as="a"
              class="torrent-button"
            >
              {t("downloads.core.torrent")}
            </Button>
            <Button
              variant="secondary"
              href={magnetUrl}
              as="a"
              class="magnet-button"
              aria-label={t("downloads.core.magnetLink")}
              title={t("downloads.core.magnetLink")}
            >
              <ColorIcon
                src={magnetIcon}
                darkSrc={magnetIconDark}
                size="1.25em"
              />
            </Button>
          </div>
        )
      }
    </div>
    <div class="metadata-links">
      {
        version && (
          <span class="version-text">
            {version} {versionName ? `(${versionName})` : ""}
          </span>
        )
      }
      {
        releaseNotesUrl && (
          <>
            {version && <span class="separator">·</span>}
            <a
              href={releaseNotesUrl}
              target="_blank"
              rel="noopener noreferrer external"
              class="metadata-link"
              set:text={t("downloads.core.releaseNotes")}
            />
          </>
        )
      }
      {
        sourceCodeUrl && (
          <>
            {(version || releaseNotesUrl) && <span class="separator">·</span>}
            <a
              href={sourceCodeUrl}
              target="_blank"
              rel="noopener noreferrer external"
              class="metadata-link"
              set:text={t("downloads.core.sourceCode")}
            />
          </>
        )
      }
    </div>
    <div class="verification">
      <h3>{t("downloads.core.verifyDownload")}</h3>
      <p
        set:html={safeMarkdown.parse(
          t("downloads.core.verifyDescription", {
            verifyInstructionLink:
              "https://docs.getmonero.org/interacting/verify-monero-binaries",
          }),
        )}
      />
      <a
        href="/downloads/hashes.txt"
        class="verify-link"
        target="_blank"
        rel="noopener noreferrer"
        set:text={t("downloads.core.viewHashes")}
      />
    </div>
  </div>
</div>

<style>
  .download-card {
    display: flex;
    flex-direction: column;
    background: var(--card-color);
    border-radius: 1rem;
    padding: 1.25rem;
    gap: 1.25rem;
  }

  .card-image {
    border-radius: 0.75rem;
    overflow: hidden;
  }

  .card-content {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .card-title {
    font-size: var(--font-size-2xl);
    font-weight: var(--font-weight-bold);
    color: var(--heading-color);
    margin: 0;
  }

  .card-subtitle {
    font-size: var(--font-size-lg);
    color: var(--paragraph-subtitle);
    margin: 0;
  }

  .card-features {
    list-style-position: inside;
    padding: 0;
    margin: 0.25rem 0 0 0;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  .card-features li {
    font-size: var(--font-size-base);
    color: var(--paragraph-main);
    line-height: var(--line-height-body);
  }
  .card-features li::marker {
    color: var(--monero-orange);
  }

  .download-actions {
    margin-top: 0.5rem;
    display: flex;
    gap: 0.75rem;
    align-items: center;
    flex-wrap: wrap;
  }

  .torrent-split-button {
    display: flex;
  }

  .torrent-split-button .button {
    border-radius: 0;
    margin: 0;
  }

  .torrent-split-button .torrent-button {
    border-start-start-radius: 22.5rem;
    border-end-start-radius: 22.5rem;
  }

  .torrent-split-button .magnet-button {
    border-start-end-radius: 22.5rem;
    border-end-end-radius: 22.5rem;
    margin-inline-start: 0.1rem;
  }

  .metadata-links {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.5rem;
    font-size: var(--font-size-sm);
    flex-wrap: wrap;
  }

  .version-text {
    color: var(--paragraph-subtitle);
    font-weight: var(--font-weight-medium);
  }

  .separator {
    color: var(--paragraph-main);
  }

  .metadata-link {
    display: flex;
    align-items: center;
    color: var(--paragraph-main);
    text-decoration: none;
    opacity: 0.8;
    transition: opacity 0.2s ease;
  }

  .metadata-link:hover {
    opacity: 1;
    text-decoration: underline;
  }

  .verification {
    margin-top: 0.75rem;
    padding-top: 0.75rem;
    border-top: 1px solid var(--border-color);
  }

  .verification h3 {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-bold);
    color: var(--heading-color);
    margin-block: 0.5rem 0;
  }

  .verification p {
    font-size: var(--font-size-sm);
    color: var(--paragraph-main);
    margin: 0 0 0.5rem 0;
  }

  .verify-link {
    color: var(--monero-orange);
    text-decoration: none;
    font-weight: var(--font-weight-medium);
  }

  .verify-link:hover {
    text-decoration: underline;
  }

  .dropdown-label {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }

  .platform-icon {
    display: inline-flex;
    align-items: center;
    opacity: 0.6;
  }

  @media (min-width: 900px) {
    .download-card {
      flex-direction: row;
      align-items: stretch;
      gap: 2rem;
      padding: 2rem;
    }

    .card-image {
      width: 40%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .card-image img {
      width: 100%;
      height: 100%;
      object-fit: contain; /* preserves aspect ratio */
    }

    .card-content {
      flex: 1 1 0%;
      min-width: 0; /* prevent overflow from long text */
    }
  }
</style>
