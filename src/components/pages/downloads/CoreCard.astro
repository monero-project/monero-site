---
import Card from "@/components/ui/Card.astro";
import type { ImageMetadata } from "astro";
import { Image } from "astro:assets";

import Button from "@/components/ui/Button.astro";
import ColorIcon from "@/components/ui/icons/ColorIcon.astro";
import Dropdown from "@/components/ui/dropdown/Dropdown.astro";
import DropdownItem from "@/components/ui/dropdown/DropdownItem.astro";
import DropdownSeparator from "@/components/ui/dropdown/DropdownSeparator.astro";
import MaskIcon from "@/components/ui/icons/MaskIcon.astro";

import magnetIconDark from "@/assets/icons/color/dark/magnet.avif";
import magnetIcon from "@/assets/icons/color/light/magnet.avif";
import androidIcon from "@/assets/icons/mask/brand/android.avif";
import appleIcon from "@/assets/icons/mask/brand/apple.avif";
import freebsdIcon from "@/assets/icons/mask/brand/freebsd.avif";
import linuxIcon from "@/assets/icons/mask/brand/linux.avif";
import windowsIcon from "@/assets/icons/mask/brand/windows.avif";

export interface DownloadLink {
  href: string;
  platform: "windows" | "macos" | "linux" | "android" | "freebsd";
  format: string;
  size?: string;
  target?: string;
}

interface Props {
  id?: string;
  image: ImageMetadata;
  title: string;
  subtitle: string;
  features: string[];
  downloads: (DownloadLink | "separator")[];
  sourceCodeUrl?: string;
  version?: string;
  versionName?: string;
  releaseNotesUrl?: string;
  torrentUrl?: string;
  magnetUrl?: string;
}

const {
  id,
  image,
  title,
  subtitle,
  features,
  downloads,
  sourceCodeUrl,
  version,
  versionName,
  releaseNotesUrl,
  torrentUrl,
  magnetUrl,
  ...rest
} = Astro.props;
const { t, safeMarkdown } = Astro.locals;

const PLATFORM_ICONS: Record<string, ImageMetadata> = {
  windows: windowsIcon,
  macos: appleIcon,
  linux: linuxIcon,
  android: androidIcon,
  freebsd: freebsdIcon,
};
---

<Card padding="none" class="download-card" id={id} {...rest}>
  <div class="card-image">
    <Image src={image} alt="" format="avif" />
  </div>
  <div class="card-content">
    <div class="card-header">
      {versionName && <span class="version-name">"{versionName}"</span>}
      <div class="title-row">
        <h2 class="card-title">{title}</h2>
        {version && <span class="version-badge">{version}</span>}
      </div>
      <p class="card-subtitle">{subtitle}</p>
    </div>
    <ul class="card-features">
      {
        features.map((feature) => (
          <li set:html={safeMarkdown.parseInline(feature ?? "")} />
        ))
      }
    </ul>
    <div class="card-footer">
      <div class="download-actions">
        <Dropdown label={t("downloads:core.downloadButton")}>
          {
            downloads.map((item) =>
              item === "separator" ? (
                <DropdownSeparator />
              ) : (
                <DropdownItem href={item.href} target={item.target}>
                  <span class="dropdown-label">
                    {item.platform && (
                      <span class="platform-icon">
                        <MaskIcon
                          src={PLATFORM_ICONS[item.platform]}
                          size="1em"
                        />
                      </span>
                    )}
                    <span>
                      {`${t(`downloads:platforms.${item.platform}`)} (${t(`downloads:core.formats.${item.format}`)})`}
                    </span>
                  </span>
                  {item.size && <span slot="meta">{item.size}</span>}
                </DropdownItem>
              ),
            )
          }
        </Dropdown>
        {
          torrentUrl && magnetUrl && (
            <div class="torrent-split-button">
              <Button
                variant="secondary"
                href={torrentUrl}
                as="a"
                class="torrent-button"
              >
                {t("downloads:core.torrent")}
              </Button>
              <Button
                variant="secondary"
                href={magnetUrl}
                as="a"
                class="magnet-button"
                aria-label={t("downloads:core.magnetLink")}
                title={t("downloads:core.magnetLink")}
              >
                <ColorIcon
                  src={magnetIcon}
                  darkSrc={magnetIconDark}
                  size="1.25em"
                />
              </Button>
            </div>
          )
        }
      </div>
      <div class="metadata-links">
        {
          releaseNotesUrl && (
            <a
              href={releaseNotesUrl}
              target="_blank"
              rel="noopener noreferrer external"
              class="metadata-link"
              set:text={t("downloads:core.releaseNotes")}
            />
          )
        }
        {
          sourceCodeUrl && (
            <>
              {releaseNotesUrl && <span class="separator">Â·</span>}
              <a
                href={sourceCodeUrl}
                target="_blank"
                rel="noopener noreferrer external"
                class="metadata-link"
                set:text={t("downloads:core.sourceCode")}
              />
            </>
          )
        }
      </div>
    </div>
  </div>
</Card>

<style>
  .download-card {
    display: flex;
    flex-direction: column;
  }

  .card-image {
    aspect-ratio: 4 / 3;
    overflow: hidden;
    border-start-start-radius: var(--radius-md);
    border-start-end-radius: var(--radius-md);
    background: var(--card-hover-color);

    & img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: top;
    }
  }

  .card-content {
    display: flex;
    flex-direction: column;
    flex: 1;
    padding: var(--space-xl);
    gap: var(--space-md);
  }

  .card-header {
    display: flex;
    flex-direction: column;
    gap: var(--space-2xs);
  }

  .title-row {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: var(--space-xs);
    flex-wrap: wrap;
  }

  .card-title {
    font-size: var(--font-size-2xl);
    font-weight: var(--font-weight-bold);
    color: var(--heading-color);
    margin: 0;
  }

  .version-badge {
    font-weight: var(--font-weight-semibold);
    background: var(--secondary-button-color, var(--footer-color));
    padding: 0.25em 0.75em;
    border-radius: var(--radius-full);
    white-space: nowrap;
  }

  .version-name {
    font-size: var(--font-size-sm);
    color: var(--paragraph-subtitle);
  }

  .card-subtitle {
    color: var(--paragraph-subtitle);
    margin: 0;
  }

  .card-features {
    list-style-position: inside;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: var(--space-2xs);

    li {
      color: var(--paragraph-main);
      line-height: var(--line-height-body);

      &::marker {
        color: var(--monero-orange);
      }
    }
  }

  .card-footer {
    margin-top: auto;
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
  }

  .download-actions {
    display: flex;
    gap: var(--space-xs);
    align-items: center;
    flex-wrap: wrap;
  }

  .torrent-split-button {
    display: flex;

    .button {
      border-radius: 0;
      margin: 0;
    }

    .torrent-button {
      border-start-start-radius: var(--radius-full);
      border-end-start-radius: var(--radius-full);
    }

    .magnet-button {
      border-start-end-radius: var(--radius-full);
      border-end-end-radius: var(--radius-full);
      margin-inline-start: 0.1rem;
    }
  }

  .metadata-links {
    margin-top: var(--space-xs);
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    font-size: var(--font-size-sm);
    flex-wrap: wrap;
  }

  .separator {
    color: var(--paragraph-main);
  }

  .metadata-link {
    display: flex;
    align-items: center;
    color: var(--paragraph-main);
    text-decoration: none;
    opacity: 0.8;
    transition: opacity 0.2s ease;

    &:hover {
      opacity: 1;
      text-decoration: underline;
    }
  }

  .dropdown-label {
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);

    .platform-icon {
      display: inline-flex;
      align-items: center;
      opacity: 0.6;
    }
  }
</style>
