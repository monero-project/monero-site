---
import { getPublicImageDimensions } from "@/utils/image";
import type { ImageMetadata } from "astro";
import { Image } from "astro:assets";

import MaskIcon from "@/components/ui/MaskIcon.astro";

import androidIcon from "@/assets/icons/mask/brand/android.avif";
import appleIcon from "@/assets/icons/mask/brand/apple.avif";
import linuxIcon from "@/assets/icons/mask/brand/linux.avif";
import windowsIcon from "@/assets/icons/mask/brand/windows.avif";

interface Tags {
  desktop?: string[]; // windows | macos | linux (aliases: win, mac, osx)
  mobile?: string[]; // android | ios
  general?: string[];
}

interface Props {
  logo: string;
  name: string;
  description: string;
  tags?: Tags;
  link: string;
  linkText?: string;
  translateTag?: (key: string) => string;
  t: (key: string) => string;
  id?: string;
}

const {
  logo,
  name,
  description,
  tags = {},
  link,
  linkText,
  translateTag,
  t,
  id,
} = Astro.props;

const norm = (s: string) => (s || "").toLowerCase().trim();
const ALIAS: Record<string, string> = {
  win: "windows",
  mac: "macos",
  osx: "macos",
};

const ICONS: Record<string, ImageMetadata> = {
  windows: windowsIcon,
  macos: appleIcon,
  linux: linuxIcon,
  android: androidIcon,
  ios: appleIcon,
};

const LABEL: Record<string, string> = {
  windows: t("downloads.platforms.windows") || "Windows",
  macos: t("downloads.platforms.macos") || "macOS",
  linux: t("downloads.platforms.linux") || "Linux",
  android: t("downloads.platforms.android") || "Android",
  ios: t("downloads.platforms.ios") || "iOS",
};

const VALID = {
  desktop: new Set(["windows", "macos", "linux"]),
  mobile: new Set(["android", "ios"]),
};

function normalizeKeys(arr: string[] | undefined, set: Set<string>) {
  return Array.from(
    new Set( // remove duplicates post-normalization
      (arr ?? [])
        .map((s) => ALIAS[norm(s)] ?? norm(s))
        .filter((k) => set.has(k)),
    ),
  );
}

const desktop = normalizeKeys(tags.desktop, VALID.desktop);
const mobile = normalizeKeys(tags.mobile, VALID.mobile);

const general = Array.from(
  new Map((tags.general ?? []).map((label) => [norm(label), label])).values(),
);

// Helper to translate a tag
const getTagLabel = (tag: string): string => {
  // Check if tag has i18n: prefix
  if (tag.startsWith("i18n:")) {
    const key = tag.slice(5);
    return translateTag ? translateTag(key) : tag;
  }

  // Otherwise return as-is (licenses, model numbers, etc.)
  return tag;
};

const showTags = general.length > 0;
const showPlatforms = desktop.length > 0 || mobile.length > 0;
const logoDimensions = await getPublicImageDimensions(logo);
const hasBuiltinExchange = general.includes("i18n:builtInExchange");
---

<div
  class={`community-card ${hasBuiltinExchange ? "has-built-in-exchange" : ""}`}
  {...id ? { id } : {}}
>
  <header class="card-header" aria-label="Project">
    <div class="card-logo" aria-hidden="true">
      <Image
        src={logo}
        alt={`${name} logo`}
        width={logoDimensions.width}
        height={logoDimensions.height}
        format="avif"
      />
    </div>
    <h3 class="card-title">{name}</h3>
  </header>

  <div class="card-description">
    <p class="card-description-text">{description}</p>

    {
      showTags && (
        <div class="card-tags" aria-label="Tags">
          <ul class="list">
            {general.map((tag) => (
              <li
                class={`pill ${tag === "i18n:builtInExchange" ? "builtin-exchange-pill" : ""}`}
              >
                <span class="tag-text">{getTagLabel(tag)}</span>
              </li>
            ))}
          </ul>
        </div>
      )
    }
  </div>

  {
    showPlatforms && (
      <div class="card-platforms" aria-label="Supported platforms">
        {desktop.length > 0 && (
          <div class="platform-row">
            <span class="platforms-label">
              {t("downloads.community.desktopLabel")}:
            </span>
            <ul class="list">
              {desktop.map((key) => (
                <li class="pill" title={LABEL[key]}>
                  <MaskIcon src={ICONS[key]} size="1.25em" aria-hidden="true" />
                </li>
              ))}
            </ul>
          </div>
        )}
        {mobile.length > 0 && (
          <div class="platform-row">
            <span class="platforms-label">
              {t("downloads.community.mobileLabel")}:
            </span>
            <ul class="list">
              {mobile.map((key) => (
                <li class="pill" title={LABEL[key]}>
                  <MaskIcon src={ICONS[key]} size="1.25em" aria-hidden="true" />
                </li>
              ))}
            </ul>
          </div>
        )}
      </div>
    )
  }

  <a
    href={link}
    class="visit-link"
    target="_blank"
    rel="noopener noreferrer external"
    set:text={linkText ?? "Visit website"}
  />
</div>

<style>
  .community-card {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    background: var(--card-color);
    border-radius: 1rem;
    padding: 1rem;
    transition: background 0.3s ease;
  }
  .card-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  .card-logo {
    width: 40px;
    height: 40px;
    flex-shrink: 0;
    overflow: hidden;
    border-radius: 0.5rem;
  }
  .card-logo img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    display: block;
  }
  .card-title {
    margin: 0;
    line-height: var(--line-height-title);
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-bold);
    color: var(--heading-color);
  }

  .card-description {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    height: 100%;
  }
  .card-description-text {
    margin: 0;
    font-size: var(--font-size-sm);
    color: var(--paragraph-main);
  }

  .list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
    margin: 0;
    padding: 0;
    list-style: none;
  }
  .pill {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.25rem 0.5rem;
    border-radius: 999px;
    background: var(--card-hover-color);
    font-size: 0.85rem;
    color: var(--paragraph-main);
    line-height: 1;
  }
  .tag-text {
    letter-spacing: 0.01em;
  }

  .card-platforms {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
    padding-top: 0.5rem;
  }
  .platform-row {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 0.5rem;
    align-items: start;
  }
  .platforms-label {
    white-space: nowrap;
    align-self: center;
    font-size: var(--font-size-xs, 0.85rem);
    color: var(--paragraph-main);
    opacity: 0.9;
  }

  .visit-link {
    display: inline-flex;
    align-items: center;
    margin-top: 0.25rem;
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    color: var(--monero-orange);
    text-decoration: none;
  }
  .visit-link:hover {
    text-decoration: underline;
  }

  body:has(#built-in-exchange:target) .builtin-exchange-pill {
    background: var(--monero-orange);
    color: white;
  }
</style>
