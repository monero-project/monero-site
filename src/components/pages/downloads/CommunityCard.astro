---
import Card from "@/components/ui/Card.astro";
import IconLink from "@/components/ui/IconLink.astro";
import MaskIcon from "@/components/ui/MaskIcon.astro";
import type { ImageMetadata } from "astro";
import { Image } from "astro:assets";

import androidIcon from "@/assets/icons/mask/brand/android.avif";
import appleIcon from "@/assets/icons/mask/brand/apple.avif";
import linuxIcon from "@/assets/icons/mask/brand/linux.avif";
import windowsIcon from "@/assets/icons/mask/brand/windows.avif";

interface Tags {
  desktop?: string[]; // windows | macos | linux (aliases: win, mac, osx)
  mobile?: string[]; // android | ios
  general?: string[];
}

interface Props {
  logo: ImageMetadata;
  name: string;
  description: string;
  tags?: Tags;
  link: string;
  linkText?: string;
  translateTag?: (key: string) => string;
  id?: string;
}

const {
  logo,
  name,
  description,
  tags = {},
  link,
  linkText,
  translateTag,
  id,
} = Astro.props;
const { t } = Astro.locals;

const norm = (s: string) => (s || "").toLowerCase().trim();
const ALIAS: Record<string, string> = {
  win: "windows",
  mac: "macos",
  osx: "macos",
};

const ICONS: Record<string, ImageMetadata> = {
  windows: windowsIcon,
  macos: appleIcon,
  linux: linuxIcon,
  android: androidIcon,
  ios: appleIcon,
};

const LABEL: Record<string, string> = {
  windows: t("downloads:platforms.windows") || "Windows",
  macos: t("downloads:platforms.macos") || "macOS",
  linux: t("downloads:platforms.linux") || "Linux",
  android: t("downloads:platforms.android") || "Android",
  ios: t("downloads:platforms.ios") || "iOS",
};

const VALID = {
  desktop: new Set(["windows", "macos", "linux"]),
  mobile: new Set(["android", "ios"]),
};

function normalizeKeys(arr: string[] | undefined, set: Set<string>) {
  return Array.from(
    new Set( // remove duplicates post-normalization
      (arr ?? [])
        .map((s) => ALIAS[norm(s)] ?? norm(s))
        .filter((k) => set.has(k)),
    ),
  );
}

const desktop = normalizeKeys(tags.desktop, VALID.desktop);
const mobile = normalizeKeys(tags.mobile, VALID.mobile);

const general = Array.from(
  new Map((tags.general ?? []).map((label) => [norm(label), label])).values(),
);

// Helper to translate a tag
const getTagLabel = (tag: string): string => {
  // Check if tag has i18n: prefix
  if (tag.startsWith("i18n:")) {
    const key = tag.slice(5);
    return translateTag ? translateTag(key) : tag;
  }

  // Otherwise return as-is (licenses, model numbers, etc.)
  return tag;
};

const showTags = general.length > 0;
const showPlatforms = desktop.length > 0 || mobile.length > 0;
const hasBuiltinExchange = general.includes("i18n:builtInExchange");
---

<Card
  padding="md"
  radius="xl"
  class:list={[
    "community-card",
    { "has-built-in-exchange": hasBuiltinExchange },
  ]}
  {...id ? { id } : {}}
>
  <header
    class="card-header"
    aria-label={t("common:components.communityCard.project")}
  >
    <div class="card-logo" aria-hidden="true">
      <Image src={logo} alt="" format="avif" />
    </div>
    <h3 class="card-title">{name}</h3>
  </header>

  <div class="card-description">
    <p class="card-description-text">{description}</p>

    {
      showTags && (
        <div
          class="card-tags"
          aria-label={t("common:components.communityCard.tags")}
        >
          <ul class="list">
            {general.map((tag) => (
              <li
                class:list={[
                  "pill",
                  { "builtin-exchange-pill": tag === "i18n:builtInExchange" },
                ]}
              >
                <span class="tag-text">{getTagLabel(tag)}</span>
              </li>
            ))}
          </ul>
        </div>
      )
    }
  </div>

  {
    showPlatforms && (
      <div
        class="card-platforms"
        aria-label={t("common:components.communityCard.supportedPlatforms")}
      >
        {desktop.length > 0 && (
          <div class="platform-row">
            <span class="platforms-label">
              {t("downloads:community.desktopLabel")}:
            </span>
            <ul class="list">
              {desktop.map((key) => (
                <li class="pill" title={LABEL[key]}>
                  <MaskIcon src={ICONS[key]} size="1.25em" aria-hidden="true" />
                </li>
              ))}
            </ul>
          </div>
        )}
        {mobile.length > 0 && (
          <div class="platform-row">
            <span class="platforms-label">
              {t("downloads:community.mobileLabel")}:
            </span>
            <ul class="list">
              {mobile.map((key) => (
                <li class="pill" title={LABEL[key]}>
                  <MaskIcon src={ICONS[key]} size="1.25em" aria-hidden="true" />
                </li>
              ))}
            </ul>
          </div>
        )}
      </div>
    )
  }

  <IconLink href={link} size="sm" weight="semibold" class="visit-link">
    {linkText ?? t("common:components.communityCard.visitWebsite")}
  </IconLink>
</Card>

<style>
  .community-card {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
  }
  .card-header {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
  }
  .card-logo {
    width: 40px;
    height: 40px;
    flex-shrink: 0;
    overflow: hidden;
    border-radius: var(--radius-md);
  }
  .card-logo img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    display: block;
  }
  .card-title {
    margin: 0;
    line-height: var(--line-height-title);
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-bold);
    color: var(--heading-color);
  }

  .card-description {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
    height: 100%;
  }
  .card-description-text {
    margin: 0;
    font-size: var(--font-size-sm);
    color: var(--paragraph-main);
  }

  .list {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2xs);
    margin: 0;
    padding: 0;
    list-style: none;
  }
  .pill {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2xs);
    padding: var(--space-2xs) var(--space-xs);
    border-radius: var(--radius-full);
    background: var(--card-hover-color);
    font-size: var(--font-size-sm);
    color: var(--paragraph-main);
    line-height: 1;
  }
  .tag-text {
    letter-spacing: 0.01em;
  }

  .card-platforms {
    display: flex;
    flex-direction: column;
    gap: var(--space-2xs);
    padding-top: var(--space-xs);
  }
  .platform-row {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: var(--space-xs);
    align-items: start;
  }
  .platforms-label {
    white-space: nowrap;
    align-self: center;
    font-size: var(--font-size-xs);
    color: var(--paragraph-main);
    opacity: 0.9;
  }

  .visit-link {
    margin-top: var(--space-2xs);
  }

  body:has(#built-in-exchange:target) .builtin-exchange-pill {
    background: var(--monero-orange);
    color: white;
  }
</style>
