---
import type { CollectionEntry } from "astro:content";
import { getCollection } from "astro:content";

import Layout from "@/layouts/Layout.astro";

import LetterGroup from "@/components/pages/resources/moneropedia/LetterGroup.astro";
import LetterNav from "@/components/pages/resources/moneropedia/LetterNav.astro";
import PageContainer from "@/components/ui/layout/PageContainer.astro";
import TitleCard from "@/components/ui/TitleCard.astro";

type MoneropediaItem = CollectionEntry<"moneropedia"> & {
  href: string;
  title: string;
  letter: string;
};

const { locale, t, localizeHref, safeMarkdown } = Astro.locals;

const entries = (
  await getCollection("moneropedia", (entry) =>
    entry.id.startsWith(`${locale}/`),
  )
).map<MoneropediaItem>((entry) => {
  const slug = entry.id.split("/").pop()!;
  const title = entry.data.title ?? entry.data.terms[0];

  // Capitalize the summary
  entry.data.summary =
    entry.data.summary.charAt(0).toUpperCase() + entry.data.summary.slice(1);

  return {
    ...entry,
    href: localizeHref(`/resources/moneropedia/${slug}/`),
    title,
    letter: title.charAt(0).toUpperCase(),
  };
});

// Group by first letter
const groups = new Map<string, MoneropediaItem[]>();
for (const entry of entries) {
  if (!groups.has(entry.letter)) groups.set(entry.letter, []);
  groups.get(entry.letter)!.push(entry);
}

const sortedLetters = Array.from(groups.keys()).sort();
for (const letter of sortedLetters) {
  groups.get(letter)!.sort((a, b) => a.title.localeCompare(b.title));
}
---

<Layout
  title={t("knowledge-base:moneropedia.pageTitle")}
  description={t("knowledge-base:moneropedia.subtitle")}
>
  <TitleCard
    title={t("knowledge-base:moneropedia.title")}
    subtitle={t("knowledge-base:moneropedia.subtitle")}
    backHref={localizeHref("/resources/knowledge-base/")}
    backLabel={t("knowledge-base:index.title")}
  />
  <PageContainer class="moneropedia-index">
    <LetterNav
      letters={sortedLetters}
      ariaLabel={t("knowledge-base:moneropedia.aria.navBar")}
    />
    <div class="letter-groups">
      {
        sortedLetters.map((letter, index) => {
          const groupEntries = groups.get(letter)!;
          const accordionItems = groupEntries.map((entry) => ({
            title: entry.title,
            content: safeMarkdown.parse(
              `${entry.data.summary}\n\n[${t("knowledge-base:moneropedia.readMore")} ](${entry.href})`,
            ),
          }));

          return (
            <LetterGroup
              letter={letter}
              items={accordionItems}
              isFirst={index === 0}
            />
          );
        })
      }
    </div>
  </PageContainer>
</Layout>

<style>
  html {
    scroll-padding-top: 4em;
    scroll-behavior: smooth;
  }

  .letter-groups {
    overflow-y: auto;
    max-height: clamp(20rem, 70vh, 60rem);
    padding-inline-start: var(--space-xs);
    scroll-behavior: smooth;
    scroll-padding-top: 0;
  }

  @media (width <= 1000px) {
    .moneropedia-index {
      display: grid;
      grid-template-columns: auto minmax(0, 1fr);
      gap: var(--space-xl);
    }

    .letter-groups {
      overflow: visible;
      max-height: none;
      padding-inline-start: 0;
    }
  }
</style>
