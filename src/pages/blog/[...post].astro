---
import "@/styles/moneropedia-link.css";

import BlogContent from "@/components/pages/blog/BlogContent.astro";
import BlogHeader from "@/components/pages/blog/BlogHeader.astro";
import {
  createTInstance,
  getLocale,
  localizeDateString,
  localizeHref,
} from "@/i18n/utils";
import { getDateStringFromId } from "@/utils/blog";
import {
  getMoneropediaEntries,
  processMoneropediaLinks,
} from "@/utils/moneropedia";
import type { GetStaticPaths } from "astro";
import type { CollectionEntry } from "astro:content";
import { getCollection } from "astro:content";
import DOMPurify from "isomorphic-dompurify";
import { marked } from "marked";
import Layout from "../../layouts/Layout.astro";

export const getStaticPaths: GetStaticPaths = async () => {
  const posts = await getCollection("blog");
  return posts.map((post) => ({
    params: { post: post.id },
    props: { post },
  }));
};

interface Props {
  post: CollectionEntry<"blog">;
}

const { post } = Astro.props;
const locale = getLocale(Astro.url);
const t = await createTInstance(locale);

// Process moneropedia links in the blog post content
const entries = await getMoneropediaEntries(locale);
const html = await marked(post.body ?? "");
const processedHtml = processMoneropediaLinks(html, entries, locale);
// Get recent posts for the sidebar
const allPosts = (await getCollection("blog")).sort((a, b) =>
  b.id.localeCompare(a.id),
);
const currentIndex = allPosts.findIndex((p) => p.id === post.id);
const N = 4;
const recentPosts = allPosts.filter((_, i) => i !== currentIndex).slice(0, N);
---

<Layout
  title={post.data.title}
  description={post.data.summary}
  openGraph={{
    basic: {
      type: "article",
      image: `/open-graph/blog/${post.id}.png`,
    },
    image: {
      alt: `OpenGraph image for Monero blog post titled "${post.data.title}"`,
    },
    article: {
      publishedTime: new Date(getDateStringFromId(post.id) ?? "").toISOString(),
      authors: post.data.author.split(/\s+and\s+|,/).map((a) => a.trim()),
      tags: post.data.tags ?? [],
    },
  }}
>
  <Fragment slot="head">
    <link
      rel="alternate"
      type="application/rss+xml"
      title="Monero Blog RSS"
      href={new URL("rss.xml", Astro.site)}
    />
  </Fragment>
  <div class="blog-container">
    <main>
      <BlogHeader
        title={post.data.title}
        id={post.id}
        author={post.data.author}
        tags={post.data.tags}
        locale={locale}
        t={t}
      />
      <BlogContent>
        <div set:html={DOMPurify.sanitize(processedHtml)} />
      </BlogContent>
    </main>

    <aside class="sidebar">
      <h2>{t("blog.post.recentPosts")}</h2>
      <ul class="recent-posts">
        {
          recentPosts.map((recentPost) => {
            const dateStr = getDateStringFromId(recentPost.id);
            const formattedDate = localizeDateString(dateStr ?? "", locale, {
              year: "numeric",
              month: "long",
              day: "numeric",
            });
            return (
              <li>
                <a
                  class="post-title"
                  href={localizeHref(locale, `/blog/${recentPost.id}/`)}
                >
                  {recentPost.data.title}
                </a>
                <time class="post-date" datetime={dateStr}>
                  {formattedDate}
                </time>
              </li>
            );
          })
        }
      </ul>
    </aside>
  </div>
</Layout>

<style>
  .blog-container {
    display: grid;
    grid-template-columns: 1fr;
    gap: 2rem;
  }

  .blog-container > * {
    min-width: 0;
  }

  .sidebar {
    border: 1px solid var(--border-color);
    padding: 1.5rem;
    border-radius: 0.5rem;
    height: fit-content;
  }

  .sidebar h2 {
    font-size: var(--font-size-xl);
    margin-top: 0;
  }

  .recent-posts {
    list-style: none;
    padding: 0;
    margin-bottom: 0;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .recent-posts li {
    margin-bottom: 0.5rem;
  }

  .recent-posts .post-date {
    display: block;
    font-size: var(--font-size-sm);
    color: var(--paragraph-subtitle);
    margin-top: 0.25rem;
  }

  .recent-posts .post-title {
    font-size: var(--font-size-md);
    color: var(--paragraph-main);
    text-decoration-line: underline;
    text-decoration-style: dotted;
  }

  .recent-posts .post-title:hover {
    text-decoration: underline;
  }

  @media (min-width: 1200px) {
    .blog-container {
      grid-template-columns: 1fr 75ch 1fr;
    }

    main {
      grid-column: 2;
    }

    .sidebar {
      grid-column: 2;
      grid-row: 2;
    }
  }

  @media (min-width: 1600px) {
    .sidebar {
      grid-column: 3;
      grid-row: 1;
    }
  }
</style>
