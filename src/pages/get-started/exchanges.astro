---
import DisclaimerNote from "@/components/ui/disclaimer/DisclaimerNote.astro";
import PageContainer from "@/components/ui/layout/PageContainer.astro";
import PageSection from "@/components/ui/layout/PageSection.astro";
import SidebarLayout from "@/components/ui/sidebar/SidebarLayout.astro";
import TitleCard from "@/components/ui/TitleCard.astro";
import Layout from "@/layouts/Layout.astro";

import kycNotMeLogo from "@/assets/images/directories/kycnotme.jpg";

import ExchangeTable from "@/components/pages/get-started/exchanges/ExchangeTable.astro";
import FilterOption from "@/components/pages/get-started/exchanges/FilterOption.astro";
import FiltersPanel from "@/components/pages/get-started/exchanges/FiltersPanel.astro";
import MobileFilterBar from "@/components/pages/get-started/exchanges/MobileFilterBar.astro";
import DisclaimerBar from "@/components/ui/disclaimer/DisclaimerBar.astro";
import ExternalResourceButton from "@/components/ui/ExternalResourceButton.astro";

import exchanges from "@/data/get-started/exchanges";
import { icons } from "@/utils/icons";

const { t, localizeHref, safeMarkdown } = Astro.locals;

const highlightOptions = [
  {
    key: "easiest",
    highlight: "user-friendly",
    icon: icons.mask("rabbit"),
    title: t("exchanges:highlightOptions.easiest.title"),
    subtitle: t("exchanges:highlightOptions.easiest.subtitle"),
  },
  {
    key: "fiat",
    highlight: "fiat",
    icon: icons.mask("bank"),
    title: t("exchanges:highlightOptions.fiat.title"),
    subtitle: t("exchanges:highlightOptions.fiat.subtitle"),
  },
  {
    key: "privacy",
    highlight: "privacy",
    icon: icons.mask("hat-glasses"),
    title: t("exchanges:highlightOptions.privacy.title"),
    subtitle: t("exchanges:highlightOptions.privacy.subtitle"),
  },
];
---

<Layout
  title={t("exchanges:pageTitle")}
  description={t("exchanges:hero.subtitle")}
>
  <TitleCard
    title={t("exchanges:hero.title")}
    subtitle={t("exchanges:hero.subtitle")}
  />

  <PageContainer>
    <!-- hidden filter radio buttons -->
    <fieldset id="exchange-filters">
      <legend class="sr-only">Exchange Filters</legend>
      {
        highlightOptions.map((opt) => {
          const filterId = `filter-${opt.key}`;
          return (
            <input
              id={filterId}
              class="filter-toggle"
              type="radio"
              name="exchange-filter"
            />
          );
        })
      }
      <input
        id="filter-none"
        class="filter-toggle"
        type="radio"
        name="exchange-filter"
        aria-label={t("exchanges:aria.clearFilters")}
        checked
      />
    </fieldset>

    <input
      id="mobile-filter-toggle"
      class="filter-toggle"
      type="checkbox"
      aria-label={t("exchanges:aria.toggleFilters")}
    />

    <div class="exchanges-wrapper">
      <SidebarLayout
        sidebarPosition="start"
        aria-label={t("exchanges:aria.pageLayout")}
        sidebarWidth="25rem"
      >
        <FiltersPanel
          slot="sidebar"
          title={t("exchanges:sidebarTitle")}
          description={t("exchanges:filtersDescription")}
          clearLabel={t("exchanges:clearSelection")}
          closeLabel={t("common:aria.close")}
          clearFilterId="filter-none"
          mobileToggleId="mobile-filter-toggle"
        >
          {
            highlightOptions.map((opt) => (
              <FilterOption
                filterId={`filter-${opt.key}`}
                highlight={opt.highlight}
                icon={opt.icon}
                title={opt.title}
                subtitle={opt.subtitle}
              />
            ))
          }
        </FiltersPanel>

        <PageSection
          title={t("exchanges:sections.decentralized.title")}
          subtitle={t("exchanges:sections.decentralized.description")}
          anchorId="decentralized"
        >
          <ExchangeTable
            exchanges={exchanges.decentralizedExchanges}
            hasKyc={false}
          />
        </PageSection>

        <hr aria-hidden="true" />

        <PageSection
          title={t("exchanges:sections.aggregators.title")}
          subtitle={t("exchanges:sections.aggregators.description")}
          anchorId="aggregators"
        >
          <DisclaimerNote
            text={t("exchanges:sections.aggregators.disclaimer")}
          />
          <p style="color: var(--paragraph-subtitle);">
            {t("exchanges:sections.aggregators.resourceIntro")}
          </p>
          <ExternalResourceButton
            href="https://kycnot.me/?categories=aggregator&currency-mode=or&currencies=xmr&max-kyc=0"
            onionHref="http://kycnotmezdiftahfmc34pqbpicxlnx3jbf5p7jypge7gdvduu7i6qjqd.onion/?categories=aggregator&currency-mode=or&currencies=xmr&max-kyc=0"
            title={t("exchanges:sections.aggregators.resourceBtnTitle")}
            subtitle={t("exchanges:sections.aggregators.resourceBtnSubtitle")}
            logo={kycNotMeLogo}
            data-highlight="user-friendly crypto"
          />
          <p
            style="color: var(--paragraph-subtitle);"
            set:html={safeMarkdown.parseInline(
              t("exchanges:sections.aggregators.tip", {
                communityDownloadsUrl: localizeHref(
                  "/downloads/community/#built-in-exchange",
                ),
              }),
            )}
          />
        </PageSection>

        <hr aria-hidden="true" />

        <PageSection
          title={t("exchanges:sections.centralized.title")}
          subtitle={t("exchanges:sections.centralized.description")}
          anchorId="centralized"
        >
          <ExchangeTable
            exchanges={exchanges.centralizedExchanges}
            hasKyc={true}
          />
        </PageSection>
      </SidebarLayout>

      <DisclaimerBar
        icon={icons.mask("shield-alert")}
        title={t("exchanges:disclaimerTitle")}
      >
        {t("exchanges:disclaimer")}
      </DisclaimerBar>

      <MobileFilterBar
        toggleId="mobile-filter-toggle"
        title={t("exchanges:sidebarTitle")}
        filterTexts={[
          {
            filter: "easiest",
            text: t("exchanges:highlightOptions.selectedText.easiest"),
          },
          {
            filter: "fiat",
            text: t("exchanges:highlightOptions.selectedText.fiat"),
          },
          {
            filter: "privacy",
            text: t("exchanges:highlightOptions.selectedText.privacy"),
          },
        ]}
      />
    </div>
  </PageContainer>
</Layout>

<style>
  fieldset {
    border: none;
    margin: 0;
    padding: 0;
    min-inline-size: 0;
    display: contents;
  }

  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  .filter-toggle {
    position: fixed;
    top: 0;
    left: 0;
    width: 0;
    height: 0;
    opacity: 0;
    pointer-events: none;
  }

  /* Filter highlighting */
  #exchange-filters:has(#filter-fiat:checked)
    ~ .exchanges-wrapper
    :global(tr[data-highlight~="fiat"]),
  #exchange-filters:has(#filter-privacy:checked)
    ~ .exchanges-wrapper
    :global(tr[data-highlight~="privacy"]),
  #exchange-filters:has(#filter-easiest:checked)
    ~ .exchanges-wrapper
    :global(tr[data-highlight~="user-friendly"]) {
    background: rgb(255 152 0 / 10%);
  }

  #exchange-filters:has(#filter-fiat:checked)
    ~ .exchanges-wrapper
    :global(.filter-option[data-highlight~="fiat"]),
  #exchange-filters:has(#filter-privacy:checked)
    ~ .exchanges-wrapper
    :global(.filter-option[data-highlight~="privacy"]),
  #exchange-filters:has(#filter-easiest:checked)
    ~ .exchanges-wrapper
    :global(.filter-option[data-highlight~="user-friendly"]) {
    background: var(--card-color);
    border-color: var(--monero-orange);
  }

  #exchange-filters:has(#filter-easiest:checked)
    ~ .exchanges-wrapper
    :global([data-highlight~="user-friendly"]:not(tr, .filter-option)) {
    outline: 2px solid var(--monero-orange);
  }

  /* Mobile filter text visibility */
  #exchange-filters:has(:checked:not(#filter-none))
    ~ .exchanges-wrapper
    :global(.mobile-filter-subtitle) {
    display: block;
  }

  #exchange-filters:has(#filter-easiest:checked)
    ~ .exchanges-wrapper
    :global(.filter-text[data-filter="easiest"]),
  #exchange-filters:has(#filter-fiat:checked)
    ~ .exchanges-wrapper
    :global(.filter-text[data-filter="fiat"]),
  #exchange-filters:has(#filter-privacy:checked)
    ~ .exchanges-wrapper
    :global(.filter-text[data-filter="privacy"]) {
    display: inline;
  }

  @media not (width >= 1200px) {
    #mobile-filter-toggle:checked ~ .exchanges-wrapper :global(.filters-panel) {
      box-shadow: 0 -8px 16px rgb(0 0 0 / 35%);
      transform: translateY(0);
      visibility: visible;
    }
  }

  @media (width >= 1200px) {
    #mobile-filter-toggle {
      display: none;
    }
  }
</style>
