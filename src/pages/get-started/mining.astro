---
import type { AccordionItemType } from "@/components/ui/Accordion.astro";
import Accordion from "@/components/ui/Accordion.astro";
import ContentCard from "@/components/ui/ContentCard.astro";
import DisclaimerBar from "@/components/ui/DisclaimerBar.astro";
import ExternalResourceButton from "@/components/ui/ExternalResourceButton.astro";
import MaskIcon from "@/components/ui/MaskIcon.astro";
import PageContainer from "@/components/ui/PageContainer.astro";
import PageSection from "@/components/ui/PageSection.astro";
import PageSectionColumn from "@/components/ui/PageSectionColumn.astro";
import TitleCard from "@/components/ui/TitleCard.astro";
import { createTInstance, getLocale, localizeHref } from "@/i18n/utils";
import Layout from "@/layouts/Layout.astro";

import appWindowIcon from "@/assets/icons/mask/app-window.avif";
import externalLinkIcon from "@/assets/icons/mask/external-link.avif";
import pickaxeIcon from "@/assets/icons/mask/pickaxe.avif";
import shieldIcon from "@/assets/icons/mask/shieldAlert.avif";
import terminalIcon from "@/assets/icons/mask/terminal.avif";

import guiWindow from "@/assets/images/gui.avif";
import gupaxWindow from "@/assets/images/gupax-window.webp";
import xmrigWindow from "@/assets/images/xmrig-window.avif";
import { createSafeMarkdown } from "@/utils/safeMarkdown";

const locale = getLocale(Astro.url);
const t = await createTInstance(locale);
const safeMarkdown = createSafeMarkdown(locale);

// Helper to convert keyed FAQ section to array for Accordion
const faqToItems = (
  faq: Record<string, { title: string; content: string }>,
): AccordionItemType[] => {
  return Object.entries(faq)
    .filter(([key]) => key !== "title") // Exclude the section title
    .map(([, item]) => ({
      title: item.title,
      content: safeMarkdown.parse(item.content),
    }));
};

const faqItems = faqToItems(
  t("mining:faq", { returnObjects: true }) as Record<
    string,
    { title: string; content: string }
  >,
);
---

<Layout title={t("mining:pageTitle")} description={t("mining:description")}>
  <TitleCard
    title={t("mining:hero.title")}
    subtitle={t("mining:hero.subtitle")}
  />
  <PageContainer>
    <PageSection ariaLabel="Mining options">
      <div class="card-grid">
        <ContentCard
          title={t("mining:gupax.title")}
          subtitle={t("mining:gupax.subtitle")}
          icon={appWindowIcon}
          image={gupaxWindow}
          imageAlt="Gupax window showing P2Pool and XMRig status"
        >
          <p>{t("mining:gupax.lead")}</p>
          <ul>
            {
              (
                t("mining:gupax.bullets", { returnObjects: true }) as string[]
              ).map((bullet: string) => <li>{bullet}</li>)
            }
          </ul>

          <a
            slot="bottom"
            href="https://gupax.io/"
            target="_blank"
            rel="noopener"
          >
            {t("mining:gupax.cta")}
            <MaskIcon src={externalLinkIcon} size="1em" />
          </a>
        </ContentCard>

        <ContentCard
          title={t("mining:xmrig.title")}
          subtitle={t("mining:xmrig.subtitle")}
          icon={terminalIcon}
          image={xmrigWindow}
          imageAlt="XMRig terminal window showing mining status"
        >
          <p>{t("mining:xmrig.lead")}</p>
          <ul>
            {
              (
                t("mining:xmrig.bullets", { returnObjects: true }) as string[]
              ).map((bullet: string) => <li>{bullet}</li>)
            }
          </ul>

          <a
            slot="bottom"
            href="https://github.com/xmrig/xmrig"
            target="_blank"
            rel="noopener"
          >
            {t("mining:xmrig.cta")}
            <MaskIcon src={externalLinkIcon} size="1em" />
          </a>
        </ContentCard>

        <ContentCard
          title={t("mining:solo.title")}
          subtitle={t("mining:solo.subtitle")}
          icon={pickaxeIcon}
          image={guiWindow}
          imageAlt="Monero GUI wallet mining tab"
        >
          <p>{t("mining:solo.lead")}</p>
          <ul>
            {
              (
                t("mining:solo.bullets", { returnObjects: true }) as string[]
              ).map((bullet: string) => <li>{bullet}</li>)
            }
          </ul>

          <a
            slot="bottom"
            href={localizeHref(locale, "/resources/user-guides/solo_mine_GUI")}
            target="_blank"
            rel="noopener noreferrer"
          >
            {t("mining:solo.cta")}
            <MaskIcon src={externalLinkIcon} size="1em" />
          </a>
        </ContentCard>
      </div>
    </PageSection>

    <hr aria-hidden="true" />

    <PageSection title={t("mining:resources.title")}>
      <PageSectionColumn columns={3} minColumnWidth="16rem">
        <PageSectionColumn title={t("mining:resources.guides.title")}>
          <ul class="resourceList">
            <li>
              <ExternalResourceButton
                href={localizeHref(
                  locale,
                  "/resources/user-guides/mine-to-pool",
                )}
                title={t("mining:resources.guides.mineToPool.title")}
                subtitle={t("mining:resources.guides.mineToPool.subtitle")}
                variant="mini"
              />
            </li>
            <li>
              <ExternalResourceButton
                href="https://gupax.io/#guide"
                title={t("mining:resources.guides.gupaxSetup.title")}
                subtitle={t("mining:resources.guides.gupaxSetup.subtitle")}
                variant="mini"
              />
            </li>
          </ul>
        </PageSectionColumn>

        <PageSectionColumn title={t("mining:resources.pools.title")}>
          <ul class="resourceList">
            <li>
              <ExternalResourceButton
                href="https://miningpoolstats.stream/monero"
                title={t("mining:resources.pools.comparePools.title")}
                subtitle={t("mining:resources.pools.comparePools.subtitle")}
                variant="mini"
              />
            </li>
          </ul>
        </PageSectionColumn>

        <PageSectionColumn title={t("mining:resources.benchmarks.title")}>
          <ul class="resourceList">
            <li>
              <ExternalResourceButton
                href="https://xmrig.com/benchmark"
                title={t("mining:resources.benchmarks.hashrateEstimates.title")}
                subtitle={t(
                  "mining:resources.benchmarks.hashrateEstimates.subtitle",
                )}
                variant="mini"
              />
            </li>
          </ul>
        </PageSectionColumn>
      </PageSectionColumn>
    </PageSection>

    <hr aria-hidden="true" />

    <PageSection class="faq" title={t("mining:faq.title")}>
      <Accordion variant="card" items={faqItems} />

      <DisclaimerBar icon={shieldIcon} title={t("mining:disclaimer.title")}>
        {t("mining:disclaimer.content")}
      </DisclaimerBar>
    </PageSection>
  </PageContainer>

  <style>
    .card-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1.25rem;
    }

    .resourceList {
      margin: 0;
      padding: 0;
      list-style: none;
      display: grid;
      gap: 0.75rem;
    }

    @media (max-width: 900px) {
      .card-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</Layout>
