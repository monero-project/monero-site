---
import Layout from "@/layouts/Layout.astro";

import CommunityCard from "@/components/pages/downloads/CommunityCard.astro";
import Grid from "@/components/ui/Grid.astro";
import PageTabs from "@/components/ui/PageTabs.astro";
import TitleCard from "@/components/ui/TitleCard.astro";

import TOCContainer from "@/components/ui/TOCContainer.astro";
import communityWallets from "@/data/downloads/community";

import serverIcon from "@/assets/icons/mask/server.avif";
import snowflakeIcon from "@/assets/icons/mask/snowflake.avif";
import walletIcon from "@/assets/icons/mask/wallet.avif";

import shieldIcon from "@/assets/icons/mask/shieldAlert.avif";
import DisclaimerBar from "@/components/ui/DisclaimerBar.astro";
import DisclaimerNote from "@/components/ui/DisclaimerNote.astro";
import PageContainer from "@/components/ui/PageContainer.astro";
import PageSection from "@/components/ui/PageSection.astro";

import type { Wallet } from "@/data/downloads/community";

export const sortWallets = (wallets: Wallet[]) =>
  // Sort by number of supported platforms (mobile + desktop), then alphabetically
  [...wallets].sort((a, b) => {
    const count = (w: Wallet) =>
      (w.tags.mobile?.length ?? 0) + (w.tags.desktop?.length ?? 0);

    return count(b) - count(a) || a.name.localeCompare(b.name);
  });

const { t, localizeHref } = Astro.locals;

const tabs = [
  { label: t("downloads:tabs.core"), link: localizeHref("/downloads") },
  {
    label: t("downloads:tabs.community"),
    link: localizeHref("/downloads/community"),
  },
];

const sections = [
  {
    id: "wallets",
    icon: walletIcon,
    title: t("downloads:community.sections.wallets.title"),
    subtitle: t("downloads:community.sections.wallets.subtitle"),
  },
  {
    id: "cold-wallets",
    icon: snowflakeIcon,
    title: t("downloads:community.sections.cold.title"),
    subtitle: t("downloads:community.sections.cold.subtitle"),
  },
  {
    id: "nodes",
    icon: serverIcon,
    title: t("downloads:community.sections.nodes.title"),
    subtitle: t("downloads:community.sections.nodes.subtitle"),
  },
];
let builtinIdAssigned = false;

const setBuiltinId = (wallet: Wallet) => {
  if (
    !builtinIdAssigned &&
    wallet.tags.general?.includes("i18n:builtInExchange")
  ) {
    builtinIdAssigned = true;
    return "built-in-exchange";
  }
  return undefined;
};
---

<Layout
  title={t("downloads:pageTitle")}
  description={t("downloads:hero.subtitle")}
>
  <TitleCard
    title={t("downloads:hero.title")}
    subtitle={t("downloads:hero.subtitle")}
  />
  <PageContainer>
    <PageTabs
      labels={tabs.map((tab) => tab.label)}
      links={tabs.map((tab) => tab.link)}
      activeIndex={1}
    />

    <TOCContainer
      sections={sections}
      ariaLabel={`${t("downloads:tabs.community")}` + " sections"}
    />

    <PageSection
      anchorId="wallets"
      title={t("downloads:community.sections.wallets.title")}
      subtitle={t("downloads:community.sections.wallets.subtitle")}
    >
      <h3 class="subheading">
        {t("downloads:community.categories.moneroOnly")}
      </h3>
      <Grid minWidth="20rem" gap="lg" class="compact-grid">
        {
          sortWallets(communityWallets.wallets.moneroOnly).map((wallet) => (
            <CommunityCard
              logo={wallet.logo}
              name={wallet.name}
              description={t(`downloads:community.descriptions.${wallet.id}`)}
              tags={wallet.tags}
              link={wallet.link}
              linkText={t("downloads:community.learnMore")}
              translateTag={(key: string) =>
                t(`downloads:community.tags.${key}`)
              }
              id={setBuiltinId(wallet)}
            />
          ))
        }
      </Grid>

      <h3 class="subheading">
        {t("downloads:community.categories.multiCoin")}
      </h3>
      <Grid minWidth="20rem" gap="lg" class="compact-grid">
        {
          sortWallets(communityWallets.wallets.multiCoin).map((wallet) => (
            <CommunityCard
              logo={wallet.logo}
              name={wallet.name}
              description={t(`downloads:community.descriptions.${wallet.id}`)}
              tags={wallet.tags}
              link={wallet.link}
              linkText={t("downloads:community.learnMore")}
              translateTag={(key: string) =>
                t(`downloads:community.tags.${key}`)
              }
              id={setBuiltinId(wallet)}
            />
          ))
        }
      </Grid>

      <h3 class="subheading">
        {t("downloads:community.categories.lws.title")}
      </h3>
      <DisclaimerNote
        text={t("downloads:community.categories.lws.disclaimer")}
      />
      <Grid minWidth="25rem" gap="lg">
        {
          sortWallets(communityWallets.wallets.lws).map((wallet) => (
            <CommunityCard
              logo={wallet.logo}
              name={wallet.name}
              description={t(`downloads:community.descriptions.${wallet.id}`)}
              tags={wallet.tags}
              link={wallet.link}
              linkText={t("downloads:community.learnMore")}
              translateTag={(key: string) =>
                t(`downloads:community.tags.${key}`)
              }
              id={setBuiltinId(wallet)}
            />
          ))
        }
      </Grid>
    </PageSection>

    <hr aria-hidden="true" />

    <PageSection
      anchorId="cold-wallets"
      title={t("downloads:community.sections.cold.title")}
      subtitle={t("downloads:community.sections.cold.subtitle")}
    >
      <Grid minWidth="25rem" gap="lg">
        {
          sortWallets(communityWallets.cold).map((wallet) => (
            <CommunityCard
              logo={wallet.logo}
              name={wallet.name}
              description={t(`downloads:community.descriptions.${wallet.id}`)}
              tags={wallet.tags}
              link={wallet.link}
              linkText={t("downloads:community.learnMore")}
              translateTag={(key: string) =>
                t(`downloads:community.tags.${key}`)
              }
              id={setBuiltinId(wallet)}
            />
          ))
        }
      </Grid>
    </PageSection>

    <hr aria-hidden="true" />

    <PageSection
      anchorId="nodes"
      title={t("downloads:community.sections.nodes.title")}
      subtitle={t("downloads:community.sections.nodes.subtitle")}
    >
      <Grid minWidth="25rem" gap="lg">
        {
          sortWallets(communityWallets.nodes).map((wallet) => (
            <CommunityCard
              logo={wallet.logo}
              name={wallet.name}
              description={t(`downloads:community.descriptions.${wallet.id}`)}
              tags={wallet.tags}
              link={wallet.link}
              linkText={t("downloads:community.learnMore")}
              translateTag={(key: string) =>
                t(`downloads:community.tags.${key}`)
              }
              id={setBuiltinId(wallet)}
            />
          ))
        }
      </Grid>
    </PageSection>

    <DisclaimerBar
      icon={shieldIcon}
      title={t("downloads:community.disclaimerTitle")}
    >
      {t("downloads:community.disclaimer")}
    </DisclaimerBar>
  </PageContainer>
</Layout>

<style>
  :global(#built-in-exchange) {
    scroll-margin-top: var(--space-4xl);
  }

  .subheading {
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-semibold);
    color: var(--heading-color);
    margin: var(--space-lg) 0 var(--space-2xs) 0;
  }

  .compact-grid {
    padding: var(--space-xs) 0 var(--space-md) 0;
  }

  @media (max-width: 1200px) {
    :global(#built-in-exchange) {
      scroll-margin-top: 6.5rem;
    }
  }
</style>
