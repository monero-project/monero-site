---
import { createTInstance, getLocale, localizeHref } from "@/i18n/utils";

import Layout from "@/layouts/Layout.astro";

import CommunityCard from "@/components/pages/downloads/CommunityCard.astro";
import Tabs from "@/components/ui/Tabs.astro";
import TitleCard from "@/components/ui/TitleCard.astro";

import TOCContainer from "@/components/ui/TOCContainer.astro";
import communityWallets from "@/data/downloads/community.json";

import serverIcon from "@/assets/icons/mask/server.avif";
import snowflakeIcon from "@/assets/icons/mask/snowflake.avif";
import walletIcon from "@/assets/icons/mask/wallet.avif";

import shieldIcon from "@/assets/icons/mask/shieldAlert.avif";
import DisclaimerBar from "@/components/ui/DisclaimerBar.astro";
import DisclaimerNote from "@/components/ui/DisclaimerNote.astro";
import PageContainer from "@/components/ui/PageContainer.astro";
import PageSection from "@/components/ui/PageSection.astro";

interface Wallet {
  id: string;
  name: string;
  logo: string;
  link: string;
  tags: {
    general?: string[];
    mobile?: string[];
    desktop?: string[];
  };
}

export const sortWallets = (wallets: Wallet[]) =>
  // Sort by number of supported platforms (mobile + desktop), then alphabetically
  [...wallets].sort((a, b) => {
    const count = (w: Wallet) =>
      (w.tags.mobile?.length ?? 0) + (w.tags.desktop?.length ?? 0);

    return count(b) - count(a) || a.name.localeCompare(b.name);
  });

const locale = getLocale(Astro.url);
const t = await createTInstance(locale);
const tabs = [
  { label: t("downloads.tabs.core"), link: localizeHref(locale, "/downloads") },
  {
    label: t("downloads.tabs.community"),
    link: localizeHref(locale, "/downloads/community"),
  },
];

const sections = [
  {
    id: "wallets",
    icon: walletIcon,
    title: t("downloads.community.sections.wallets.title"),
    subtitle: t("downloads.community.sections.wallets.subtitle"),
  },
  {
    id: "cold-wallets",
    icon: snowflakeIcon,
    title: t("downloads.community.sections.cold.title"),
    subtitle: t("downloads.community.sections.cold.subtitle"),
  },
  {
    id: "nodes",
    icon: serverIcon,
    title: t("downloads.community.sections.nodes.title"),
    subtitle: t("downloads.community.sections.nodes.subtitle"),
  },
];
let builtinIdAssigned = false;

const setBuiltinId = (wallet: Wallet) => {
  if (
    !builtinIdAssigned &&
    wallet.tags.general?.includes("i18n:builtInExchange")
  ) {
    builtinIdAssigned = true;
    return "built-in-exchange";
  }
  return undefined;
};
---

<Layout
  title={t("downloads.pageTitle")}
  description={t("downloads.heroSubtitle")}
>
  <TitleCard
    title={t("downloads.heroTitle")}
    subtitle={t("downloads.heroSubtitle")}
  />
  <Tabs
    labels={tabs.map((tab) => tab.label)}
    links={tabs.map((tab) => tab.link)}
    activeIndex={1}
  />

  <TOCContainer
    sections={sections}
    ariaLabel={`${t("downloads.tabs.community")}` + " sections"}
  />

  <PageContainer>
    <PageSection
      class="downloads-section"
      anchorId="wallets"
      title={t("downloads.community.sections.wallets.title")}
      subtitle={t("downloads.community.sections.wallets.subtitle")}
    >
      <h3 class="subheading">
        {t("downloads.community.categories.moneroOnly")}
      </h3>
      <div class="cards-grid compact">
        {
          sortWallets(communityWallets.wallets.moneroOnly).map((wallet) => (
            <CommunityCard
              logo={wallet.logo}
              name={wallet.name}
              description={t(`downloads.community.descriptions.${wallet.id}`)}
              tags={wallet.tags}
              link={wallet.link}
              linkText={t("downloads.community.learnMore")}
              translateTag={(key: string) =>
                t(`downloads.community.tags.${key}`)
              }
              t={t}
              id={setBuiltinId(wallet)}
            />
          ))
        }
      </div>

      <h3 class="subheading">
        {t("downloads.community.categories.multiCoin")}
      </h3>
      <div class="cards-grid compact">
        {
          sortWallets(communityWallets.wallets.multiCoin).map((wallet) => (
            <CommunityCard
              logo={wallet.logo}
              name={wallet.name}
              description={t(`downloads.community.descriptions.${wallet.id}`)}
              tags={wallet.tags}
              link={wallet.link}
              linkText={t("downloads.community.learnMore")}
              translateTag={(key: string) =>
                t(`downloads.community.tags.${key}`)
              }
              t={t}
              id={setBuiltinId(wallet)}
            />
          ))
        }
      </div>

      <h3 class="subheading">
        {t("downloads.community.categories.lws.title")}
      </h3>
      <DisclaimerNote
        text={t("downloads.community.categories.lws.disclaimer")}
      />
      <div class="cards-grid">
        {
          sortWallets(communityWallets.wallets.lws).map((wallet) => (
            <CommunityCard
              logo={wallet.logo}
              name={wallet.name}
              description={t(`downloads.community.descriptions.${wallet.id}`)}
              tags={wallet.tags}
              link={wallet.link}
              linkText={t("downloads.community.learnMore")}
              translateTag={(key: string) =>
                t(`downloads.community.tags.${key}`)
              }
              t={t}
              id={setBuiltinId(wallet)}
            />
          ))
        }
      </div>
    </PageSection>

    <hr aria-hidden="true" />

    <PageSection
      class="downloads-section"
      anchorId="cold-wallets"
      title={t("downloads.community.sections.cold.title")}
      subtitle={t("downloads.community.sections.cold.subtitle")}
    >
      <div class="cards-grid">
        {
          sortWallets(communityWallets.cold).map((wallet) => (
            <CommunityCard
              logo={wallet.logo}
              name={wallet.name}
              description={t(`downloads.community.descriptions.${wallet.id}`)}
              tags={wallet.tags}
              link={wallet.link}
              linkText={t("downloads.community.learnMore")}
              translateTag={(key: string) =>
                t(`downloads.community.tags.${key}`)
              }
              t={t}
              id={setBuiltinId(wallet)}
            />
          ))
        }
      </div>
    </PageSection>

    <hr aria-hidden="true" />

    <PageSection
      class="downloads-section"
      anchorId="nodes"
      title={t("downloads.community.sections.nodes.title")}
      subtitle={t("downloads.community.sections.nodes.subtitle")}
    >
      <div class="cards-grid">
        {
          sortWallets(communityWallets.nodes).map((wallet) => (
            <CommunityCard
              logo={wallet.logo}
              name={wallet.name}
              description={t(`downloads.community.descriptions.${wallet.id}`)}
              tags={wallet.tags}
              link={wallet.link}
              linkText={t("downloads.community.learnMore")}
              translateTag={(key: string) =>
                t(`downloads.community.tags.${key}`)
              }
              t={t}
              id={setBuiltinId(wallet)}
            />
          ))
        }
      </div>
    </PageSection>

    <DisclaimerBar icon={shieldIcon} title="Disclaimer">
      This list is for informational purposes only. The Monero Project does not
      endorse, recommend, or guarantee any service listed here. Always
      double-check URLs, start with a small test amount if you're unsure, and
      use every service at your own risk.
    </DisclaimerBar>
  </PageContainer>
</Layout>

<style>
  :global(#built-in-exchange) {
    scroll-margin-top: 3rem;
  }

  .subheading {
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-semibold);
    color: var(--heading-color);
    margin: 1.25rem 0 0.25rem 0;
  }

  .cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(25rem, 1fr));
    gap: 1.25rem;
  }

  .cards-grid.compact {
    grid-template-columns: repeat(auto-fit, minmax(20rem, 1fr));
    padding: 0.5rem 0 1rem 0;
  }

  @media (max-width: 900px) {
    .cards-grid,
    .cards-grid.compact {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
  }

  @media (max-width: 1200px) {
    .section-title,
    :global(#built-in-exchange) {
      scroll-margin-top: 6.5rem;
    }
  }
</style>
