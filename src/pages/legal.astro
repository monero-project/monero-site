---
import PageContainer from "@/components/ui/PageContainer.astro";
import PageSection from "@/components/ui/PageSection.astro";
import TitleCard from "@/components/ui/TitleCard.astro";
import TOCContainer from "@/components/ui/TOCContainer.astro";
import Layout from "@/layouts/Layout.astro";
import { getCollection, render } from "astro:content";

import copyrightIcon from "@/assets/icons/mask/copyright.avif";
import receiptTextIcon from "@/assets/icons/mask/receiptText.avif";
import shieldCheckIcon from "@/assets/icons/mask/shieldCheck.avif";

const { t } = Astro.locals;

const sections = [
  {
    id: "terms-of-use",
    title: t("legal:sections.termsOfUse.title"),
    icon: receiptTextIcon,
    subtitle: t("legal:sections.termsOfUse.tocSubtitle"),
  },
  {
    id: "copyright",
    title: t("legal:sections.copyright.title"),
    icon: copyrightIcon,
    subtitle: t("legal:sections.copyright.tocSubtitle"),
  },
  {
    id: "privacy-policy",
    title: t("legal:sections.privacyPolicy.title"),
    icon: shieldCheckIcon,
    subtitle: t("legal:sections.privacyPolicy.tocSubtitle"),
  },
];

const legalContent = await getCollection("legal");
const renderedSections = await Promise.all(
  sections.map(async (section) => {
    const entry = legalContent.find((e) => e.id === section.id);
    if (!entry) {
      throw new Error(
        `Legal section ${section.id} not found. Ensure the section ID matches the file name in the src/content/legal directory.`,
      );
    }
    const { Content } = await render(entry);
    return { ...section, Content };
  }),
);
---

<Layout title={t("legal:pageTitle")} description={t("legal:description")}>
  <TitleCard title={t("legal:title")} subtitle={t("legal:subtitle")} centered />

  <PageContainer>
    <TOCContainer sections={sections} ariaLabel={t("legal:aria.sectionsNav")} />

    <div class="legal-content">
      {
        renderedSections.map((section, index) => (
          <>
            {index > 0 && <hr aria-hidden="true" />}
            <PageSection title={section.title} anchorId={section.id} centered>
              <div class="prose">
                <section.Content />
              </div>
            </PageSection>
          </>
        ))
      }
    </div>
  </PageContainer>
</Layout>

<style>
  .legal-content {
    display: flex;
    flex-direction: column;
    max-width: 75ch;
    margin-inline: auto;
  }

  .prose {
    line-height: var(--line-height-body);
  }

  .prose :global(h3) {
    font-size: var(--font-size-lg);
    color: var(--heading-color);
    margin: 2rem 0 0.75rem;
  }

  .prose :global(h3:first-child) {
    margin-top: 0;
  }

  .prose :global(p) {
    margin: 0 0 1rem;
  }

  .prose :global(li) {
    margin-bottom: 0.5rem;
  }
</style>
