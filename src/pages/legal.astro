---
import PageContainer from "@/components/ui/layout/PageContainer.astro";
import PageSection from "@/components/ui/layout/PageSection.astro";
import Column from "@/components/ui/layout/Column.astro";
import TitleCard from "@/components/ui/TitleCard.astro";
import TOCContainer from "@/components/ui/toc/TOCContainer.astro";
import Layout from "@/layouts/Layout.astro";
import { getCollection, render } from "astro:content";
import { icons } from "@/utils/icons";

const { t } = Astro.locals;

const sections = [
  {
    id: "terms-of-use",
    title: t("legal:sections.termsOfUse.title"),
    icon: icons.mask("receipt-text"),
    subtitle: t("legal:sections.termsOfUse.tocSubtitle"),
  },
  {
    id: "copyright",
    title: t("legal:sections.copyright.title"),
    icon: icons.mask("copyright"),
    subtitle: t("legal:sections.copyright.tocSubtitle"),
  },
  {
    id: "privacy-policy",
    title: t("legal:sections.privacyPolicy.title"),
    icon: icons.mask("shield-check"),
    subtitle: t("legal:sections.privacyPolicy.tocSubtitle"),
  },
];

const legalContent = await getCollection("legal");
const renderedSections = await Promise.all(
  sections.map(async (section) => {
    const entry = legalContent.find((e) => e.id === section.id);
    if (!entry) {
      throw new Error(
        `Legal section ${section.id} not found. Ensure the section ID matches the file name in the src/content/legal directory.`,
      );
    }
    const { Content } = await render(entry);
    return { ...section, Content };
  }),
);
---

<Layout title={t("legal:pageTitle")} description={t("legal:description")}>
  <TitleCard title={t("legal:title")} subtitle={t("legal:subtitle")} centered />

  <PageContainer>
    <TOCContainer sections={sections} ariaLabel={t("legal:aria.sectionsNav")} />

    <Column class="legal-content">
      {
        renderedSections.map((section, index) => (
          <>
            {index > 0 && <hr aria-hidden="true" />}
            <PageSection title={section.title} anchorId={section.id} centered>
              <div class="prose">
                <section.Content />
              </div>
            </PageSection>
          </>
        ))
      }
    </Column>
  </PageContainer>
</Layout>

<style>
  .legal-content {
    max-width: 75ch;
    margin-inline: auto;
  }

  .prose {
    line-height: var(--line-height-body);

    & :global(h3) {
      font-size: var(--font-size-lg);
      color: var(--heading-color);
      margin: var(--space-2xl) 0 var(--space-sm);

      &:first-child {
        margin-top: 0;
      }
    }

    & :global(p) {
      margin: 0 0 var(--space-md);
    }

    & :global(li) {
      margin-bottom: var(--space-xs);
    }
  }
</style>
